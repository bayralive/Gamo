<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; background: #e5e5e5; }
        
        /* üõ°Ô∏è BLACK WATER DROP PIN STYLE */
        .black-pin {
            width: 30px; height: 30px;
            background: black;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            margin-top: -30px; /* Offset to point exactly at center */
            margin-left: -15px;
        }
        .black-pin::after {
            content: ''; position: absolute;
            width: 10px; height: 10px;
            background: white; border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([6.0333, 37.5500], 15);
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);

        var pickupMarker = null;
        var dropoffMarker = null;
        var routePolyline = null;
        var mode = "PICKUP"; // PICKUP or DROPOFF

        // ICON DEF
        var blackIcon = L.divIcon({ className: 'custom-div-icon', html: "<div class='black-pin'></div>", iconSize: [30, 42], iconAnchor: [15, 42] });

        // LISTENER: Update Android on center movement
        map.on('move', function() {
            var c = map.getCenter();
            if (window.Android) { window.Android.onMapMove(c.lat, c.lng, mode); }
        });

        // üü¢ FUNCTION: LOCK PICKUP
        function lockPickup(lat, lng) {
            if (pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker([lat, lng], {icon: blackIcon}).addTo(map);
            mode = "DROPOFF";
            // Offset map slightly to show next step
            map.panBy([0, 100]); 
        }

        // üî¥ FUNCTION: CALCULATE ROUTE (Using OSRM Public API)
        function calcRoute(pLat, pLng, dLat, dLng) {
            if (dropoffMarker) map.removeLayer(dropoffMarker);
            dropoffMarker = L.marker([dLat, dLng], {icon: blackIcon}).addTo(map);

            var url = "https://router.project-osrm.org/route/v1/driving/" + pLng + "," + pLat + ";" + dLng + "," + dLat + "?overview=full&geometries=geojson";
            
            fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    var route = data.routes[0];
                    var distKm = route.distance / 1000;
                    
                    // Draw Line
                    var geo = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    if (routePolyline) map.removeLayer(routePolyline);
                    routePolyline = L.polyline(geo, {color: '#5E4E92', weight: 5}).addTo(map);
                    map.fitBounds(routePolyline.getBounds(), {padding: [50, 50]});

                    // Send distance back to Android
                    if (window.Android) window.Android.onRouteCalculated(distKm);
                }
            })
            .catch(err => console.log(err));
        }

        function resetMap() {
            if (pickupMarker) map.removeLayer(pickupMarker);
            if (dropoffMarker) map.removeLayer(dropoffMarker);
            if (routePolyline) map.removeLayer(routePolyline);
            pickupMarker = null; dropoffMarker = null; routePolyline = null;
            mode = "PICKUP";
        }
    </script>
</body>
</html>
